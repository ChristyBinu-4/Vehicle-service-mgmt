{% extends "user_sidebar.html" %}
{% block content %}

<div class="container-fluid p-4">
    <!-- Success/Error Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Breadcrumb -->
    <nav class="mb-3 text-muted">
        Home / Work Status / <strong>SRV-{{ booking.id }}</strong>
    </nav>

        
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <!-- Back Button -->
            <a href="{% url 'user_work_status' %}" class="btn btn-outline-secondary btn-sm mb-2">
                ← Back to Work Status
            </a>

            <h3 class="fw-bold mb-1">
                Service Request #SRV-{{ booking.id }}
            </h3>

            <span class="badge
                {% if booking.status == 'Requested' %}bg-warning
                {% elif booking.status == 'Accepted' %}bg-info
                {% elif booking.status == 'Pending' %}bg-secondary
                {% elif booking.status == 'Ongoing' %}bg-primary
                {% elif booking.status == 'Completed' %}bg-success
                {% else %}bg-danger{% endif %}
            ">
                {{ booking.get_status_display }}
            </span>
            {% if booking.status == 'Completed' and booking.payment_requested %}
            <span class="badge bg-warning ms-2">
                <i class="bi bi-credit-card me-1"></i>Payment Requested
            </span>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">

        <!-- LEFT COLUMN -->
        <div class="col-lg-4">

            <!-- Vehicle Card -->
            <div class="bg-white p-4 rounded shadow-sm mb-4">
                <h6 class="fw-semibold mb-3">Vehicle Details</h6>
                <p><strong>{{ booking.vehicle_make }} {{ booking.vehicle_model }}</strong></p>
                <p>Year: {{ booking.year }}</p>
                <p>Fuel: {{ booking.fuel_type }}</p>
                <p>Number: {{ booking.vehicle_number }}</p>
            </div>

            <!-- Service Center Card -->
            <div class="bg-white p-4 rounded shadow-sm mb-4">
                <h6 class="fw-semibold mb-2">Service Center</h6>
                <p class="fw-bold">{{ booking.servicer.name }}</p>
                <p class="text-muted">{{ booking.servicer.location }}</p>
                <p>⭐ {{ booking.servicer.rating }}</p>
                <p>{{ booking.servicer.available_time }}</p>
                <p class="text-muted small mt-2"><strong>Work Type:</strong> {{ booking.work_type }}</p>
            </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-lg-8">

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="bookingTabs" role="tablist">

                <!-- Service Log Tab -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link active"
                            id="log-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#log"
                            type="button"
                            role="tab">
                        Service Log
                    </button>
                </li>

                <!-- Diagnostics Tab (ONLY WHEN AVAILABLE) -->
                <!-- Diagnosis is visible ONLY when:
                     1. Booking status is "Pending"
                     2. Diagnosis exists -->
                {% if diagnosis_visible and diagnosis %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="diagnostics-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#diagnostics"
                            type="button"
                            role="tab">
                        Diagnostics
                    </button>
                </li>
                {% endif %}

                <!-- Payment Tab (ONLY WHEN COMPLETED AND PAYMENT REQUESTED) -->
                {% if booking.status == 'Completed' and booking.payment_requested %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="payment-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#payment"
                            type="button"
                            role="tab">
                        <i class="bi bi-credit-card me-1"></i>Payment
                    </button>
                </li>
                {% endif %}

            </ul>

<div class="tab-content">

    <!-- Service Log Content -->
    <div class="tab-pane fade show active"
         id="log"
         role="tabpanel">

        <div class="bg-white p-4 rounded shadow-sm">
            <h6 class="fw-semibold mb-3">
                <i class="bi bi-clock-history me-2"></i>Work Progress Timeline
            </h6>
            {% if progress %}
                <div class="timeline">
                    {% for p in progress %}
                        <div class="border-start border-primary border-3 ps-4 mb-4 position-relative">
                            <!-- Timeline dot -->
                            <span class="position-absolute top-0 start-0 translate-middle bg-primary rounded-circle" style="width: 12px; height: 12px; margin-left: -6px;"></span>
                            
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="fw-semibold mb-0">{{ p.title }}</h6>
                                <span class="badge 
                                    {% if p.status == 'Pending' %}bg-secondary
                                    {% elif p.status == 'In Progress' %}bg-primary
                                    {% elif p.status == 'Completed' %}bg-success
                                    {% endif %}
                                ">
                                    {{ p.get_status_display }}
                                </span>
                            </div>
                            <p class="mb-2 text-muted">{{ p.description }}</p>
                            <small class="text-muted d-flex align-items-center">
                                <i class="bi bi-clock me-1"></i>
                                {{ p.updated_at|date:"M d, Y h:i A" }}
                            </small>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                    <p class="text-muted mb-0">No progress updates yet.</p>
                    <small class="text-muted">Progress updates will appear here as work progresses.</small>
                </div>
            {% endif %}
        </div>

          </div>

          <!-- Diagnostics Content (ONLY WHEN AVAILABLE) -->
          <!-- Diagnosis tab is visible ONLY when:
               1. Booking status is "Pending"
               2. Diagnosis exists -->
          {% if diagnosis_visible and diagnosis %}
          <div class="tab-pane fade"
              id="diagnostics"
              role="tabpanel">

              <div class="bg-white p-4 rounded shadow-sm">
                  <h6 class="fw-semibold mb-3">Diagnosis Report</h6>

                  <!-- Diagnosis Description -->
                  <div class="mb-3">
                      <strong>Diagnosis:</strong>
                      <p class="mt-2">{{ diagnosis.report }}</p>
                  </div>

                  <!-- Work Items -->
                  {% if diagnosis.work_items %}
                  <div class="mb-3">
                      <strong>Work Items:</strong>
                      <ul class="mt-2">
                          {% for item in diagnosis.get_work_items_list %}
                          <li>{{ item }}</li>
                          {% endfor %}
                      </ul>
                  </div>
                  {% endif %}

                  <!-- Estimated Cost -->
                  {% if diagnosis.estimated_cost %}
                  <div class="mb-3">
                      <strong>Estimated Cost:</strong> ₹{{ diagnosis.estimated_cost }}
                  </div>
                  {% endif %}

                  <!-- Estimated Completion Time -->
                  {% if diagnosis.estimated_completion_time %}
                  <div class="mb-3">
                      <strong>Estimated Completion Time:</strong> {{ diagnosis.estimated_completion_time }}
                  </div>
                  {% endif %}

                  <!-- Approve Diagnosis Button -->
                  <!-- Only show if diagnosis is not already approved -->
                  {% if not diagnosis.user_approved %}
                  <form method="POST" action="{% url 'approve_diagnosis' booking.id %}" class="mt-4">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-success">
                          Approve Diagnosis
                      </button>
                  </form>
                  {% else %}
                  <div class="alert alert-success mt-3">
                      <strong>✓ Diagnosis Approved</strong>
                      <p class="mb-0">Work has started. You can track progress in the Service Log tab.</p>
                  </div>
                  {% endif %}
              </div>

          </div>
          {% endif %}

      </div>


            <!-- Complaints -->
            {% if complaint_list %}
            <div class="bg-white p-4 rounded shadow-sm mt-4">
                <h6 class="fw-semibold mb-2">Reported Issues</h6>
                <ul>
                    {% for c in complaint_list %}
                        <li>{{ c }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

          </div>

          <!-- Payment Request Section (ONLY WHEN COMPLETED) -->
          {% if booking.status == 'Completed' and booking.payment_requested %}
          <div class="tab-pane fade" id="payment" role="tabpanel">
              <div class="bg-white p-4 rounded shadow-sm">
                  <div class="alert alert-warning mb-4">
                      <h6 class="fw-semibold mb-2">
                          <i class="bi bi-credit-card me-2"></i>Payment Request
                      </h6>
                      <p class="mb-0">The servicer has requested payment for the completed service.</p>
                  </div>
                  
                  <div class="card border-primary">
                      <div class="card-header bg-primary text-white">
                          <h6 class="mb-0 fw-semibold">Payment Details</h6>
                      </div>
                      <div class="card-body">
                          {% if booking.final_amount %}
                          <div class="mb-3">
                              <h5 class="fw-bold text-primary">₹{{ booking.final_amount }}</h5>
                              <p class="text-muted mb-0">Final Amount</p>
                          </div>
                          {% endif %}
                          
                          {% if booking.completion_notes %}
                          <div class="mb-3">
                              <h6 class="fw-semibold">Completion Notes:</h6>
                              <p class="text-muted">{{ booking.completion_notes }}</p>
                          </div>
                          {% endif %}
                          
                          <div class="alert alert-info mb-0">
                              <i class="bi bi-info-circle me-2"></i>
                              Please contact the service center to complete the payment.
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          {% endif %}

    </div>
</div>

{% endblock %}
